{% extends "base.html" %}
{% block content %}
<section class="card">
  <h2>ğŸ… Rate a Treat</h2>
  <form id="rateForm">
    <label>Select Baker</label>
    <select id="entrant" required>
      <option value="" disabled selected>Who baked this?</option>
      {% for name in entrants %}<option value="{{ loop.index0 }}">{{ name }}</option>{% endfor %}
    </select>

    <div class="slider-wrap">
      <label>Taste ğŸ˜‹</label>
      <input type="range" min="1" max="5" value="3" id="taste" oninput="syncEmoji()">
      <div class="row"><span id="tasteEmoji">ğŸ™‚</span><span id="tasteScore">3/5</span></div>
    </div>

    <div class="slider-wrap">
      <label>Presentation ğŸ“¸</label>
      <input type="range" min="1" max="5" value="3" id="presentation" oninput="syncEmoji()">
      <div class="row"><span id="presEmoji">ğŸ™‚</span><span id="presScore">3/5</span></div>
    </div>

    <div class="slider-wrap">
      <label>Christmas Spirit ğŸ„</label>
      <input type="range" min="1" max="5" value="3" id="spirit" oninput="syncEmoji()">
      <div class="row"><span id="spiritEmoji">ğŸ™‚</span><span id="spiritScore">3/5</span></div>
    </div>

    <label>One Word Description (Optional)</label>
    <input type="text" id="one_word" placeholder="e.g. Magical">

    <label>Your Name (Optional)</label>
    <input type="text" id="judge" placeholder="Who are you?">

    <button type="submit" class="btn">Submit Rating ğŸ</button>
  </form>
</section>

<section class="card">
  <h2>ğŸ† Live Leaderboard</h2>
  <table class="table" id="lbTable">
    <thead><tr><th>Rank</th><th>Baker</th><th>Votes</th><th>Total</th></tr></thead>
    <tbody></tbody>
  </table>
  <p style="text-align:center; margin-top:10px;"><a href="/words">View One-Word Descriptions</a></p>
</section>

<script>
const emojis = {1:'ğŸ¥¶', 2:'ğŸ˜', 3:'ğŸ™‚', 4:'ğŸ˜‹', 5:'ğŸ¤¤'};
const spiritEmojis = {1:'ğŸ§Š', 2:'ğŸ˜', 3:'ğŸ™‚', 4:'ğŸ„', 5:'ğŸ…'};

function syncEmoji(){
  document.getElementById('tasteEmoji').innerText = emojis[document.getElementById('taste').value];
  document.getElementById('presEmoji').innerText = emojis[document.getElementById('presentation').value];
  document.getElementById('spiritEmoji').innerText = spiritEmojis[document.getElementById('spirit').value];
  
  ['taste','presentation','spirit'].forEach(id => {
      document.getElementById(id+'Score').innerText = document.getElementById(id).value + "/5";
  });
}

document.getElementById('rateForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const payload = {
    entrant_index: document.getElementById('entrant').value,
    taste: document.getElementById('taste').value,
    presentation: document.getElementById('presentation').value,
    spirit: document.getElementById('spirit').value,
    one_word: document.getElementById('one_word').value,
    judge: document.getElementById('judge').value
  };
  await fetch('/api/rate', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
  alert("Vote Saved! ğŸ…");
  refreshLB();
});

async function refreshLB(){
  const res = await fetch('/api/leaderboard');
  const data = await res.json();
  const tbody = document.querySelector('#lbTable tbody');
  tbody.innerHTML = data.map((r, i) => `
    <tr><td>#${i+1}</td><td>${r.name}</td><td>${r.votes}</td><td><strong>${r.avg_total}</strong></td></tr>
  `).join('');
}
refreshLB();
setInterval(refreshLB, 5000);
syncEmoji();
</script>
{% endblock %}
