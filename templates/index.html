<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>{{ title }}</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <div class="snowflake">â…</div><div class="snowflake">â†</div><div class="snowflake">â…</div><div class="snowflake">â†</div><div class="snowflake">â…</div><div class="snowflake">â†</div><div class="snowflake">â…</div><div class="snowflake">â†</div>

  <div class="wrap">
    <h1>ğŸ… 2025 Baking Comp ğŸª</h1>
    
    <section class="card">
      <h2>Rate a Treat</h2>
      <form id="rateForm">
        <label>Select Baker</label>
        <select id="entrant" required>
          <option value="" disabled selected>Select...</option>
          {% for name in entrants %}<option value="{{ loop.index0 }}">{{ name }}</option>{% endfor %}
        </select>

        <div class="slider-container" style="margin-top:30px;">
            <span class="slider-label">Taste ğŸ˜‹</span>
            <span class="score-display" id="disp-taste">5</span>
            <div class="track"><div class="track-fill" id="fill-taste" style="width: 50%"></div></div>
            <div class="thumb-emoji" id="thumb-taste">ğŸ™‚</div>
            <input type="range" min="1" max="10" value="5" id="taste" oninput="updateAll('taste')">
        </div>

        <div class="slider-container" style="margin-top:30px;">
            <span class="slider-label">Presentation ğŸ“¸</span>
            <span class="score-display" id="disp-pres">5</span>
            <div class="track"><div class="track-fill" id="fill-pres" style="width: 50%"></div></div>
            <div class="thumb-emoji" id="thumb-pres">ğŸ™‚</div>
            <input type="range" min="1" max="10" value="5" id="pres" oninput="updateAll('pres')">
        </div>

        <div class="anim-box" id="snowman-scene" style="margin-top:30px">
            <div id="snow-ground"></div>
            <div id="snowman-wrap">
                <div class="sb base" id="sb1"></div>
                <div class="sb mid" id="sb2"></div>
                <div class="sb head" id="sb3"></div>
            </div>
        </div>
        <div class="slider-container">
            <span class="slider-label" style="top:-35px">Xmas Spirit ğŸ„</span>
            <span class="score-display" id="disp-spirit" style="top:-35px">5</span>
            <div class="track"><div class="track-fill" id="fill-spirit" style="width: 50%"></div></div>
            <div class="thumb-emoji" id="thumb-spirit">ğŸ™‚</div>
            <input type="range" min="1" max="10" value="5" id="spirit" oninput="updateAll('spirit')">
        </div>

        <input type="text" id="one_word" placeholder="One Word Description">
        <input type="text" id="judge" placeholder="Your Name (Optional)">
        <button type="submit" class="btn">Submit Vote ğŸ</button>
    </form>
    </section>

    <section class="card">
      <h2>ğŸ† Live Leaderboard</h2>
      <table class="table" id="lbTable">
        <thead><tr><th>#</th><th style="text-align:left">Baker</th><th>T</th><th>P</th><th>S</th><th>Avg</th></tr></thead>
        <tbody></tbody>
      </table>
      <div style="text-align:center; margin-top:15px">
        <a href="/words">Word Cloud</a> | <a href="/admin">Admin Login</a>
      </div>
    </section>
  </div>

<script>
const faceEmojis = ['ğŸ¥¶','ğŸ¥¶','ğŸ˜','ğŸ˜','ğŸ™‚','ğŸ™‚','ğŸ˜‹','ğŸ˜‹','ğŸ¤¤','ğŸ¤¤'];
const spiritEmojis = ['ğŸ§Š','ğŸ§Š','ğŸ˜','ğŸ˜','ğŸ™‚','ğŸ™‚','ğŸ„','ğŸ„','ğŸ…','ğŸ…'];

function updateAll(id) {
    const val = document.getElementById(id).value;
    const pct = (val - 1) * 11.1;

    document.getElementById('disp-' + id).innerText = val;
    document.getElementById('fill-' + id).style.width = pct + '%';
    const thumb = document.getElementById('thumb-' + id);
    thumb.style.left = pct + '%';
    const emojiSet = (id === 'spirit') ? spiritEmojis : faceEmojis;
    thumb.innerText = emojiSet[val - 1];

    if (id === 'spirit') {
        const s1 = document.getElementById('sb1'), s2 = document.getElementById('sb2'), s3 = document.getElementById('sb3');
        s1.classList.remove('visible'); s2.classList.remove('visible'); s3.classList.remove('visible');
        if (val >= 1) s1.classList.add('visible');
        if (val >= 4) s2.classList.add('visible');
        if (val >= 7) s3.classList.add('visible');
    }
}

updateAll('taste'); updateAll('pres'); updateAll('spirit');

document.getElementById('rateForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.querySelector('.btn');
    const oldText = btn.innerText;
    btn.innerText = "Saving..."; btn.disabled = true;

    const payload = {
        entrant_index: document.getElementById('entrant').value,
        taste: document.getElementById('taste').value,
        presentation: document.getElementById('pres').value,
        spirit: document.getElementById('spirit').value,
        one_word: document.getElementById('one_word').value,
        judge: document.getElementById('judge').value
    };

    try {
        const res = await fetch('/api/rate', {
            method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
        });
        const data = await res.json();
        if(res.ok && data.ok) {
            alert("Vote Cast! ğŸ„");
            await loadLB(); 
        } else {
            alert("Error saving vote: " + (data.error || "Unknown error"));
        }
    } catch(err) { alert("Connection error. Try again."); }

    btn.innerText = oldText; btn.disabled = false;
});

async function loadLB(){
    try {
        const res = await fetch('/api/leaderboard');
        const data = await res.json();
        const tbody = document.querySelector('#lbTable tbody');
        if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="6">No votes yet!</td></tr>'; return; }
        tbody.innerHTML = data.map((r, i) => `
            <tr><td>${i+1}</td><td style="text-align:left">${r.name}<br><small style="color:#999">${r.votes} votes</small></td>
            <td>${r.avg_t}</td><td>${r.avg_p}</td><td>${r.avg_s}</td><td><strong>${r.avg_total}</strong></td></tr>
        `).join('');
    } catch(e) { console.log("LB Error", e); }
}
loadLB(); setInterval(loadLB, 5000);
</script>
</body>
</html>
