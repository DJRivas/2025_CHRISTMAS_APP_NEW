<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>{{ title }}</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <div class="wrap">
    <h1>ğŸ… 2025 Baking Comp ğŸª</h1>
    
    <section class="card">
      <h2>Rate a Treat</h2>
      <form id="rateForm">
        <label>Select Baker</label>
        <select id="entrant" required>
          <option value="" disabled selected>Select...</option>
          {% for name in entrants %}<option value="{{ loop.index0 }}">{{ name }}</option>{% endfor %}
        </select>

        <div class="anim-box active">
            <div class="stars"></div>
            <div id="santa-mover">
                <svg viewBox="0 0 64 64"><path d="M12 40 Q20 50 30 40 T50 40 L55 35 L45 35 L40 20 L25 25 L20 35 Z M20 35 L10 35 L5 25" fill="white"/></svg>
            </div>
        </div>
        <div class="slider-container">
            <span class="slider-label">Taste ğŸ˜‹</span>
            <span class="score-display" id="disp-taste">5</span>
            <div class="track"><div class="track-fill" id="fill-taste" style="width: 50%"></div></div>
            <div class="thumb-emoji" id="thumb-taste">ğŸ™‚</div>
            <input type="range" min="1" max="10" value="5" id="taste" oninput="updateAll('taste')">
        </div>

        <div class="slider-container" style="margin-top:20px;">
            <span class="slider-label">Presentation ğŸ“¸</span>
            <span class="score-display" id="disp-pres">5</span>
            <div class="track"><div class="track-fill" id="fill-pres" style="width: 50%"></div></div>
            <div class="thumb-emoji" id="thumb-pres">ğŸ™‚</div>
            <input type="range" min="1" max="10" value="5" id="pres" oninput="updateAll('pres')">
        </div>

        <div class="anim-box active" id="snowman-scene" style="margin-top:30px">
            <div id="snow-ground"></div>
            <div id="snowman-wrap">
                <div class="sb base" id="sb1"></div>
                <div class="sb mid" id="sb2"></div>
                <div class="sb head" id="sb3"></div>
            </div>
        </div>
        <div class="slider-container">
            <span class="slider-label">Xmas Spirit ğŸ„</span>
            <span class="score-display" id="disp-spirit">5</span>
            <div class="track"><div class="track-fill" id="fill-spirit" style="width: 50%"></div></div>
            <div class="thumb-emoji" id="thumb-spirit">ğŸ™‚</div>
            <input type="range" min="1" max="10" value="5" id="spirit" oninput="updateAll('spirit')">
        </div>

        <input type="text" id="one_word" placeholder="One Word Description">
        <input type="text" id="judge" placeholder="Your Name (Optional)">
        <button type="submit" class="btn">Submit Vote ğŸ</button>
    </form>
    </section>

    <section class="card">
      <h2>ğŸ† Live Leaderboard</h2>
      <table class="table" id="lbTable">
        <thead><tr><th>#</th><th style="text-align:left">Baker</th><th>T</th><th>P</th><th>S</th><th>Avg</th></tr></thead>
        <tbody></tbody>
      </table>
      <div style="text-align:center; margin-top:15px">
        <a href="/words">Word Cloud</a> | <a href="/admin">Admin Login</a>
      </div>
    </section>
  </div>

<script>
// Logic to map 1-10 to Emojis
const faceEmojis = ['ğŸ¥¶','ğŸ¥¶','ğŸ˜','ğŸ˜','ğŸ™‚','ğŸ™‚','ğŸ˜‹','ğŸ˜‹','ğŸ¤¤','ğŸ¤¤'];
const spiritEmojis = ['ğŸ§Š','ğŸ§Š','ğŸ˜','ğŸ˜','ğŸ™‚','ğŸ™‚','ğŸ„','ğŸ„','ğŸ…','ğŸ…'];

function updateAll(id) {
    const val = document.getElementById(id).value;
    const pct = (val - 1) * 11.1; // 0 to 100 scale approximately

    // 1. Update Number Display
    document.getElementById('disp-' + id).innerText = val;

    // 2. Update Track Fill
    document.getElementById('fill-' + id).style.width = pct + '%';

    // 3. Move Emoji Thumb
    const thumb = document.getElementById('thumb-' + id);
    thumb.style.left = pct + '%';

    // 4. Change Emoji Face
    const emojiSet = (id === 'spirit') ? spiritEmojis : faceEmojis;
    thumb.innerText = emojiSet[val - 1];

    // 5. Special Animations
    if (id === 'taste') {
        // Move Santa across the sky (10% to 90%)
        const santaPos = 5 + (val * 8.5); 
        document.getElementById('santa-mover').style.left = santaPos + '%';
    }
    if (id === 'spirit') {
        // Build Snowman logic
        const s1 = document.getElementById('sb1');
        const s2 = document.getElementById('sb2');
        const s3 = document.getElementById('sb3');
        
        // Reset classes
        s1.classList.remove('visible'); s2.classList.remove('visible'); s3.classList.remove('visible');
        
        if (val >= 1) s1.classList.add('visible');
        if (val >= 4) s2.classList.add('visible');
        if (val >= 7) s3.classList.add('visible');
    }
}

// Initial Setup
updateAll('taste'); updateAll('pres'); updateAll('spirit');

// Submit Logic
document.getElementById('rateForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.querySelector('.btn');
    const oldText = btn.innerText;
    btn.innerText = "Saving...";
    btn.disabled = true;

    const payload = {
        entrant_index: document.getElementById('entrant').value,
        taste: document.getElementById('taste').value,
        presentation: document.getElementById('pres').value,
        spirit: document.getElementById('spirit').value,
        one_word: document.getElementById('one_word').value,
        judge: document.getElementById('judge').value
    };

    try {
        const res = await fetch('/api/rate', {
            method:'POST', 
            headers:{'Content-Type':'application/json'}, 
            body:JSON.stringify(payload)
        });
        if(res.ok) {
            alert("Vote Cast! ğŸ„");
            // IMMEDIATE REFRESH
            await loadLB(); 
        } else {
            alert("Error saving vote.");
        }
    } catch(err) {
        alert("Connection error.");
    }

    btn.innerText = oldText;
    btn.disabled = false;
});

// Leaderboard Logic
async function loadLB(){
    try {
        const res = await fetch('/api/leaderboard');
        const data = await res.json();
        const tbody = document.querySelector('#lbTable tbody');
        
        if(data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6">No votes yet!</td></tr>';
            return;
        }

        tbody.innerHTML = data.map((r, i) => `
            <tr>
                <td>${i+1}</td>
                <td style="text-align:left">${r.name}<br><small style="color:#999">${r.votes} votes</small></td>
                <td>${r.avg_t}</td>
                <td>${r.avg_p}</td>
                <td>${r.avg_s}</td>
                <td><strong>${r.avg_total}</strong></td>
            </tr>
        `).join('');
    } catch(e) { console.log("LB Error", e); }
}

loadLB();
setInterval(loadLB, 5000); // Poll every 5s just in case
</script>
</body>
</html>
